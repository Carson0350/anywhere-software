---
// Contact Form Component
---

<section id="contact" class="py-24 bg-neutral-50">
  <div class="max-w-3xl mx-auto px-4">
    <h2 class="text-4xl md:text-5xl font-bold font-heading text-neutral-900 text-center mb-4">
      Start Your Transformation
    </h2>
    <p class="text-xl text-neutral-700 text-center mb-4 max-w-2xl mx-auto">
      Tell us about your business. We'll reach out within 24 hours.
    </p>

    <!-- Trust signals -->
    <p class="text-sm text-neutral-600 text-center mb-2">
      ✓ Free consultation • ✓ No obligation • ✓ 24-hour response
    </p>

    <!-- Social proof -->
    <p class="text-sm text-neutral-600 text-center mb-12">
      Join 50+ rural businesses who've transformed their online presence
    </p>

    <form id="contact-form" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="name" class="block text-sm font-medium text-neutral-700 mb-2">
            Your Name *
          </label>
          <input
            type="text"
            id="name"
            name="name"
            required
            class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
            placeholder="Mary Jane"
          />
          <p class="text-sm text-error mt-1 hidden error-message" role="alert" aria-live="polite">
            Please enter your name
          </p>
        </div>

        <div>
          <label for="email" class="block text-sm font-medium text-neutral-700 mb-2">
            Email Address *
          </label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
            placeholder="you@example.com"
          />
          <p class="text-sm text-error mt-1 hidden error-message" role="alert" aria-live="polite">
            Please enter a valid email
          </p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="business-type" class="block text-sm font-medium text-neutral-700 mb-2">
            Business Type *
          </label>
          <select
            id="business-type"
            name="businessType"
            required
            class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
          >
            <option value="">Select one...</option>
            <option value="campground">Campground</option>
            <option value="winery">Winery</option>
            <option value="restaurant">Restaurant</option>
            <option value="other">Other</option>
          </select>
          <p class="text-sm text-error mt-1 hidden error-message" role="alert" aria-live="polite">
            Please select your business type
          </p>
        </div>

        <div>
          <label for="location" class="block text-sm font-medium text-neutral-700 mb-2">
            Location *
          </label>
          <input
            type="text"
            id="location"
            name="location"
            required
            class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
            placeholder="Portland, OR"
          />
          <p class="text-sm text-error mt-1 hidden error-message" role="alert" aria-live="polite">
            Please enter your location
          </p>
        </div>
      </div>

      <div>
        <label for="message" class="block text-sm font-medium text-neutral-700 mb-2">
          Tell us about your needs *
        </label>
        <textarea
          id="message"
          name="message"
          required
          rows="4"
          class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
          placeholder="I need a new website for my campground..."
        ></textarea>
        <p class="text-sm text-error mt-1 hidden error-message" role="alert" aria-live="polite">
          Please tell us about your needs
        </p>
      </div>

      <!-- Honeypot spam protection (hidden from users) -->
      <div style="position: absolute; left: -5000px;" aria-hidden="true">
        <input type="text" name="_gotcha" tabindex="-1" autocomplete="off" />
      </div>

      <!-- Progressive disclosure for optional fields -->
      <details class="border-t border-neutral-200 pt-6">
        <summary class="cursor-pointer text-primary-600 font-semibold hover:text-primary-700 transition-colors">
          + Add more details (optional - helps us prepare better)
        </summary>
        <div class="mt-6 space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="budget" class="block text-sm font-medium text-neutral-700 mb-2">
                Budget Range
              </label>
              <select
                id="budget"
                name="budget"
                class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
              >
                <option value="">Select one...</option>
                <option value="under-5k">Under $5,000</option>
                <option value="5k-15k">$5,000 - $15,000</option>
                <option value="15k-25k">$15,000 - $25,000</option>
                <option value="25k-plus">$25,000+</option>
                <option value="not-sure">Not sure yet</option>
              </select>
            </div>

            <div>
              <label for="timeline" class="block text-sm font-medium text-neutral-700 mb-2">
                Timeline
              </label>
              <select
                id="timeline"
                name="timeline"
                class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
              >
                <option value="">Select one...</option>
                <option value="asap">ASAP</option>
                <option value="1-3-months">1-3 months</option>
                <option value="3-6-months">3-6 months</option>
                <option value="exploring">Just exploring</option>
              </select>
            </div>
          </div>

          <div>
            <label for="current-website" class="block text-sm font-medium text-neutral-700 mb-2">
              Current Website (if you have one)
            </label>
            <input
              type="url"
              id="current-website"
              name="currentWebsite"
              class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
              placeholder="https://example.com"
            />
          </div>
        </div>
      </details>

      <button
        type="submit"
        class="w-full md:w-auto px-10 py-4 bg-primary-500 text-white rounded-lg font-semibold hover:bg-primary-600 transition-colors text-lg"
      >
        Request Consultation
      </button>

      <!-- Privacy reassurance -->
      <p class="text-xs text-neutral-500 mt-4">
        We respect your privacy. Your information will never be shared.
      </p>
    </form>
  </div>
</section>

<script>
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const submitButton = form?.querySelector('button[type="submit"]') as HTMLButtonElement;

  const fields = {
    name: form?.querySelector('#name') as HTMLInputElement,
    email: form?.querySelector('#email') as HTMLInputElement,
    businessType: form?.querySelector('#business-type') as HTMLSelectElement,
    location: form?.querySelector('#location') as HTMLInputElement,
    message: form?.querySelector('#message') as HTMLTextAreaElement
  };

  // Email validation regex (RFC 5322 simplified)
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  // Debounced validation to prevent lag
  let validationTimeout: number;

  // Validate on blur
  Object.entries(fields).forEach(([name, field]) => {
    field?.addEventListener('blur', () => validateField(name, field));

    // Debounced validation on input (only if field has error)
    field?.addEventListener('input', () => {
      if (field.classList.contains('border-error')) {
        clearTimeout(validationTimeout);
        validationTimeout = window.setTimeout(() => {
          validateField(name, field);
        }, 300); // Wait 300ms after user stops typing
      }
    });
  });

  function validateField(name: string, field: HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement) {
    const value = field.value.trim();
    const errorElement = field.nextElementSibling as HTMLElement;

    let isValid = true;
    let errorMessage = '';

    if (name === 'email') {
      isValid = emailRegex.test(value);
      errorMessage = 'Please enter a valid email address (e.g., you@example.com)';
    } else if (name === 'businessType') {
      isValid = value !== '';
      errorMessage = 'Please select your business type';
    } else if (name === 'name') {
      isValid = value.length > 0;
      errorMessage = 'Please enter your name';
    } else if (name === 'location') {
      isValid = value.length > 0;
      errorMessage = 'Please enter your city and state';
    } else if (name === 'message') {
      isValid = value.length > 0;
      errorMessage = 'Please tell us about your needs';
    }

    if (isValid) {
      field.classList.remove('border-error');
      field.classList.add('border-success');
      errorElement?.classList.add('hidden');
    } else {
      field.classList.add('border-error');
      field.classList.remove('border-success');
      errorElement?.classList.remove('hidden');
      if (errorElement) {
        errorElement.textContent = errorMessage;
      }
    }

    return isValid;
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Validate all fields before submission
    let isFormValid = true;
    Object.entries(fields).forEach(([name, field]) => {
      if (!validateField(name, field)) {
        isFormValid = false;
      }
    });

    if (!isFormValid) {
      // Focus first invalid field
      const firstInvalid = form.querySelector('.border-error') as HTMLElement;
      firstInvalid?.focus();
      return;
    }

    // Show loading state
    const originalText = submitButton.textContent;
    submitButton.textContent = 'Sending...';
    submitButton.disabled = true;

    const formData = new FormData(form);

    try {
      const response = await fetch('https://formspree.io/f/mvgeqbew', {
        method: 'POST',
        body: formData,
        headers: {
          'Accept': 'application/json'
        }
      });

      if (response.ok) {
        // Success
        form.reset();
        showSuccessMessage();

        // Track successful submission
        if (typeof (window as any).va !== 'undefined') {
          (window as any).va('event', 'contact_form_submit', {
            businessType: formData.get('businessType'),
            location: formData.get('location'),
            budget: formData.get('budget') || 'not-provided',
            timeline: formData.get('timeline') || 'not-provided'
          });
        }
      } else {
        // Handle Formspree-specific errors
        const data = await response.json();

        if (data.errors) {
          // Show field-specific errors from Formspree
          data.errors.forEach((error: any) => {
            const field = form.querySelector(`[name="${error.field}"]`) as HTMLElement;
            if (field) {
              const errorElement = field.nextElementSibling as HTMLElement;
              field.classList.add('border-error');
              errorElement?.classList.remove('hidden');
              errorElement.textContent = error.message;
            }
          });
        } else {
          showErrorMessage('Oops! Something went wrong. Please try again.');
        }
      }
    } catch (error) {
      showErrorMessage('Network error. Please check your connection.');
    } finally {
      if (submitButton) {
        submitButton.textContent = originalText;
        submitButton.disabled = false;
      }
    }
  });

  function showSuccessMessage() {
    const successDiv = document.createElement('div');
    successDiv.className = 'bg-success/10 border-2 border-success text-success px-6 py-4 rounded-lg mb-6';
    successDiv.textContent = "Thanks! We'll reach out within 24 hours.";
    form.insertBefore(successDiv, form.firstChild);

    setTimeout(() => successDiv.remove(), 5000);
  }

  function showErrorMessage(message: string) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'bg-error/10 border-2 border-error text-error px-6 py-4 rounded-lg mb-6';
    errorDiv.textContent = message;
    form.insertBefore(errorDiv, form.firstChild);

    setTimeout(() => errorDiv.remove(), 5000);
  }
</script>
